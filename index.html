<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent TAO</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        .agent-header {
            background: #4a90e2;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        
        .agent-title {
            font-size: 18px;
            margin: 0;
        }
        
        .agent-description {
            font-size: 14px;
            opacity: 0.8;
            margin: 5px 0 0 0;
        }
        
        .widget-container {
            flex: 1;
            position: relative;
        }
        
        /* Masquer les éléments du widget officiel que nous ne voulons pas */
        .vfrc-widget--launcher {
            display: none !important;
        }
        
        /* Forcer le widget à prendre tout l'espace */
        .vfrc-widget {
            position: fixed !important;
            top: 70px !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: calc(100vh - 70px) !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        
        .vfrc-widget--chat {
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="agent-header">
        <h1 class="agent-title" id="agent-title">Chargement...</h1>
        <p class="agent-description" id="agent-description">Initialisation...</p>
    </div>
    
    <div class="widget-container" id="widget-container">
        <!-- Le widget Voiceflow sera injecté ici -->
    </div>

    <script>
        // Configuration des agents
        const AGENT_MAP = {
            '1-3': {
                title: 'Semaine 1 - Agent 3',
                description: 'Violence - Sensibilisation'
            },
            '1-5': {
                title: 'Semaine 1 - Agent 5',
                description: 'Emotion - Colère'
            },
            '1-6': {
                title: 'Semaine 1 - Agent 6',
                description: 'Emotion - Tristesse'
            }
        };

        // Extraire l'agent de l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentAgent = urlParams.get('agent') || 'default';
        const userID = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Configuration de l'agent
        const agentInfo = AGENT_MAP[currentAgent] || {
            title: currentAgent.charAt(0).toUpperCase() + currentAgent.slice(1),
            description: 'Votre assistant personnel'
        };

        // Mise à jour de l'interface
        document.getElementById('agent-title').textContent = agentInfo.title;
        document.getElementById('agent-description').textContent = agentInfo.description;

        // Configuration du widget Voiceflow officiel
        (function(d, t) {
            var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
            v.onload = function() {
                window.voiceflow.chat.load({
                    verify: { projectID: '68a6e2cc67f4932838663766' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    autostart: true,
                    session: {
                        userID: userID,
                        variables: {
                            agentID: currentAgent,
                            agent: currentAgent,
                            userID: userID
                        }
                    },
                    assistant: {
                        title: agentInfo.title,
                        description: agentInfo.description
                    }
                }).then(() => {
                    console.log('Widget Voiceflow chargé pour agent:', currentAgent);
                    console.log('Variables de session:', {
                        agentID: currentAgent,
                        agent: currentAgent,
                        userID: userID
                    });
                    
                    // Forcer l'ouverture du chat
                    setTimeout(() => {
                        window.voiceflow.chat.open();
                        
                        // Envoyer les variables dans un message système
                        setTimeout(() => {
                            window.voiceflow.chat.interact({
                                type: 'launch',
                                payload: {
                                    agentID: currentAgent,
                                    agent: currentAgent
                                }
                            });
                        }, 1000);
                    }, 500);
                }).catch((error) => {
                    console.error('Erreur de chargement du widget:', error);
                });
            };
            v.src = "https://cdn.voiceflow.com/widget/bundle.mjs";
            v.type = "text/javascript";
            s.parentNode.insertBefore(v, s);
        })(document, 'script');

        // Debug
        console.log('Configuration:', {
            currentAgent: currentAgent,
            agentInfo: agentInfo,
            userID: userID
        });
    </script>
</body>
</html>
