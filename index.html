<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voiceflow Agent - TAO semaine 2</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        #voiceflow-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        /* Styles pour mode iframe dans Adalo */
        .adalo-mode {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            width: 100% !important;
            height: 100vh !important;
            background-color: white;
        }
        
        /* Message de chargement */
        #loading-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Message de chargement -->
    <div id="loading-message">
        Chargement de l'agent...
    </div>
    
    <!-- Container pour le widget Voiceflow -->
    <div id="voiceflow-chat"></div>
    
    <script>
        // Configuration de base avec vos vraies données
        const BASE_CONFIG = {
            verify: { 
                projectID: '68a6e2cc67f4932838663766'
            },
            url: 'https://general-runtime.voiceflow.com',
            versionID: '68a6e2cc67f4932838663767', // Utilise la version ID spécifique
            voice: {
                url: 'https://runtime-api.voiceflow.com'
            },
            autostart: true,
            allowDangerousHTML: true,
            assistant: {
                title: 'TAO semaine 2',
                description: 'Votre assistant personnel',
                image: 'https://via.placeholder.com/150x150/4f46e5/ffffff?text=TAO'
            }
        };

        // Token API pour les requêtes avancées si nécessaire
        const API_TOKEN = 'VF.DM.68b95b26d255357adc1f9c55.OG2nx9m7CmY7d6BP';
        
        // Fonction pour extraire les paramètres de l'URL
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Fonction pour générer un ID utilisateur unique
        function generateUserID() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Configuration finale
        let voiceflowConfig = { ...BASE_CONFIG };
        
        // Récupérer les paramètres depuis l'URL pour personnalisation
        const flowID = getURLParameter('flowID');
        const userID = getURLParameter('userID') || generateUserID();
        const customTitle = getURLParameter('title');
        const theme = getURLParameter('theme') || 'light';
        
        // Configuration de session avec variables personnalisées
        voiceflowConfig.session = {
            userID: userID,
            variables: {}
        };
        
        // Ajouter le flowID si spécifié pour diriger vers un flow spécifique
        if (flowID) {
            voiceflowConfig.session.variables.targetFlow = flowID;
            voiceflowConfig.session.variables.flowID = flowID;
            console.log('Flow ID configuré:', flowID);
        }
        
        // Personnaliser le titre si spécifié
        if (customTitle) {
            voiceflowConfig.assistant.title = decodeURIComponent(customTitle);
        }
        
        // Détecter si on est dans un iframe (Adalo)
        const isInIframe = window.self !== window.top;
        if (isInIframe) {
            document.getElementById('voiceflow-chat').className = 'adalo-mode';
            console.log('Mode Adalo détecté');
        }
        
        // Fonction pour initialiser Voiceflow
        function initializeVoiceflow() {
            try {
                console.log('Initialisation du widget Voiceflow...', voiceflowConfig);
                
                window.voiceflow.chat.load(voiceflowConfig).then(() => {
                    console.log('Widget Voiceflow chargé avec succès');
                    document.getElementById('loading-message').classList.add('hidden');
                    
                    // Envoyer le flowID au début de la conversation si spécifié
                    if (flowID) {
                        setTimeout(() => {
                            window.voiceflow.chat.interact({
                                type: 'launch',
                                payload: {
                                    variables: {
                                        flowID: flowID,
                                        targetFlow: flowID
                                    }
                                }
                            });
                        }, 1000);
                    }
                }).catch((error) => {
                    console.error('Erreur lors du chargement du widget:', error);
                    document.getElementById('loading-message').textContent = 'Erreur de chargement. Veuillez rafraîchir la page.';
                });
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                document.getElementById('loading-message').textContent = 'Erreur d\'initialisation. Veuillez rafraîchir la page.';
            }
        }
        
        // Charger le script Voiceflow
        (function(d, t) {
            var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
            
            v.onload = function() {
                console.log('Script Voiceflow chargé');
                initializeVoiceflow();
            };
            
            v.onerror = function() {
                console.error('Erreur lors du chargement du script Voiceflow');
                document.getElementById('loading-message').textContent = 'Impossible de charger l\'agent. Vérifiez votre connexion.';
            };
            
            v.src = "https://cdn.voiceflow.com/widget/bundle.mjs";
            v.type = "text/javascript";
            s.parentNode.insertBefore(v, s);
        })(document, 'script');
        
        // Gestion des messages pour Adalo
        if (isInIframe) {
            window.addEventListener('message', function(event) {
                console.log('Message reçu d\'Adalo:', event.data);
                
                // Traiter les commandes d'Adalo
                if (event.data && event.data.action) {
                    switch(event.data.action) {
                        case 'startFlow':
                            if (event.data.flowID && window.voiceflow) {
                                window.voiceflow.chat.interact({
                                    type: 'launch',
                                    payload: {
                                        variables: {
                                            flowID: event.data.flowID,
                                            targetFlow: event.data.flowID
                                        }
                                    }
                                });
                            }
                            break;
                        case 'reset':
                            if (window.voiceflow) {
                                window.voiceflow.chat.reset();
                            }
                            break;
                    }
                }
            });
            
            // Notifier Adalo que le widget est prêt
            window.parent.postMessage({
                type: 'voiceflow-ready',
                timestamp: Date.now()
            }, '*');
        }
        
        // Log des paramètres pour débogage
        console.log('Paramètres URL détectés:', {
            flowID: flowID,
            userID: userID,
            customTitle: customTitle,
            theme: theme,
            isInIframe: isInIframe
        });
    </script>
</body>
</html>
