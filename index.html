<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voiceflow Agent - TAO</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        #voiceflow-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        /* Styles pour mode iframe dans Adalo */
        .adalo-mode {
            position: relative !important;
            bottom: auto !important;
            right: auto !important;
            width: 100% !important;
            height: 100vh !important;
            background-color: white;
        }
        
        /* Message de chargement */
        #loading-message {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }
        
        .agent-info {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Message de chargement -->
    <div id="loading-message">
        <div>Chargement de l'agent...</div>
        <div class="agent-info" id="agent-info"></div>
    </div>
    
    <!-- Container pour le widget Voiceflow -->
    <div id="voiceflow-chat"></div>
    
    <script>
        // Configuration de base avec vos vraies donn√©es
        const BASE_CONFIG = {
            verify: { 
                projectID: '68a6e2cc67f4932838663766'
            },
            url: 'https://general-runtime.voiceflow.com',
            versionID: '68a6e2cc67f4932838663767',
            voice: {
                url: 'https://runtime-api.voiceflow.com'
            },
            autostart: true,
            allowDangerousHTML: true,
            assistant: {
                title: 'TAO Agent',
                description: 'Votre assistant personnel',
                image: 'https://via.placeholder.com/150x150/4f46e5/ffffff?text=TAO'
            }
        };

        // Token API pour les requ√™tes avanc√©es
        const API_TOKEN = 'VF.DM.68b95b26d255357adc1f9c55.OG2nx9m7CmY7d6BP';
        
        // Fonction pour extraire les param√®tres de l'URL
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Fonction pour g√©n√©rer un ID utilisateur unique
        function generateUserID() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Fonction pour formater le titre de l'agent
        function formatAgentTitle(agentID) {
            if (!agentID) return 'TAO Agent';
            
            // Si format semaine-agent (ex: 1-3, 2-5)
            if (agentID.match(/^\d+-\d+$/)) {
                const parts = agentID.split('-');
                return `Semaine ${parts[0]} - Agent ${parts[1]}`;
            }
            
            // Sinon, capitaliser le nom
            return agentID.replace(/_/g, ' ')
                          .split(' ')
                          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                          .join(' ');
        }
        
        // R√©cup√©rer les param√®tres de l'URL
        const agentParam = getURLParameter('agent'); // N'importe quel agent
        const userID = getURLParameter('userID') || generateUserID();
        const debug = getURLParameter('debug') === 'true';
        const customTitle = getURLParameter('title');
        
        // D√©terminer quel agent utiliser (g√©n√©rique)
        let currentAgent = agentParam || 'default'; // Agent par d√©faut si non sp√©cifi√©
        
        // G√©n√©rer le titre automatiquement
        let agentTitle = customTitle ? decodeURIComponent(customTitle) : formatAgentTitle(currentAgent);
        
        // Afficher les informations de l'agent en cours de chargement
        document.getElementById('agent-info').textContent = `Agent: ${currentAgent}`;
        
        // Configuration finale avec les variables d'agent (g√©n√©rique)
        let voiceflowConfig = { ...BASE_CONFIG };
        voiceflowConfig.assistant.title = agentTitle;
        
        // Configuration de session avec variables universelles
        voiceflowConfig.session = {
            userID: userID,
            variables: {
                agentID: currentAgent, // Envoie directement la valeur de l'URL
                userID: userID,
                timestamp: Date.now()
            }
        };
        
        // Ajouter des variables suppl√©mentaires si format semaine-agent
        if (currentAgent.match(/^\d+-\d+$/)) {
            const parts = currentAgent.split('-');
            voiceflowConfig.session.variables.semaine = parts[0];
            voiceflowConfig.session.variables.numeroAgent = parts[1];
        }
        
        // Ajouter toutes les autres variables de l'URL
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            if (key !== 'agent' && key !== 'debug' && key !== 'title') {
                voiceflowConfig.session.variables[key] = value;
            }
        }
        
        // D√©tecter si on est dans un iframe (Adalo)
        const isInIframe = window.self !== window.top;
        if (isInIframe) {
            document.getElementById('voiceflow-chat').className = 'adalo-mode';
            console.log('Mode Adalo d√©tect√©');
        }
        
        // Fonction pour initialiser Voiceflow
        function initializeVoiceflow() {
            try {
                console.log('Initialisation du widget Voiceflow...', voiceflowConfig);
                
                window.voiceflow.chat.load(voiceflowConfig).then(() => {
                    console.log('Widget Voiceflow charg√© avec succ√®s');
                    console.log('Variables envoy√©es:', voiceflowConfig.session.variables);
                    document.getElementById('loading-message').classList.add('hidden');
                    
                    // S'assurer que les variables sont bien transmises
                    setTimeout(() => {
                        window.voiceflow.chat.interact({
                            type: 'launch',
                            payload: voiceflowConfig.session.variables
                        });
                        console.log('Variables transmises au lancement:', voiceflowConfig.session.variables);
                    }, 1000);
                    
                }).catch((error) => {
                    console.error('Erreur lors du chargement du widget:', error);
                    document.getElementById('loading-message').innerHTML = 
                        '<div>Erreur de chargement</div><div class="agent-info">Veuillez rafra√Æchir la page</div>';
                });
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                document.getElementById('loading-message').innerHTML = 
                    '<div>Erreur d\'initialisation</div><div class="agent-info">Veuillez rafra√Æchir la page</div>';
            }
        }
        
        // Charger le script Voiceflow
        (function(d, t) {
            var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
            
            v.onload = function() {
                console.log('Script Voiceflow charg√©');
                initializeVoiceflow();
            };
            
            v.onerror = function() {
                console.error('Erreur lors du chargement du script Voiceflow');
                document.getElementById('loading-message').innerHTML = 
                    '<div>Impossible de charger l\'agent</div><div class="agent-info">V√©rifiez votre connexion</div>';
            };
            
            v.src = "https://cdn.voiceflow.com/widget/bundle.mjs";
            v.type = "text/javascript";
            s.parentNode.insertBefore(v, s);
        })(document, 'script');
        
        // Gestion des messages pour Adalo
        if (isInIframe) {
            window.addEventListener('message', function(event) {
                console.log('Message re√ßu d\'Adalo:', event.data);
                
                // Traiter les commandes d'Adalo
                if (event.data && event.data.action) {
                    switch(event.data.action) {
                        case 'changeAgent':
                            if (event.data.agentID) {
                                // Recharger avec le nouvel agent
                                window.location.search = `?agent=${event.data.agentID}`;
                            }
                            break;
                        case 'reset':
                            if (window.voiceflow) {
                                window.voiceflow.chat.reset();
                            }
                            break;
                    }
                }
            });
            
            // Notifier Adalo que le widget est pr√™t
            window.parent.postMessage({
                type: 'voiceflow-ready',
                agent: currentAgent,
                timestamp: Date.now()
            }, '*');
        }
        
        // Log des param√®tres pour d√©bogage (toujours actif pour les tests)
        console.log('üîç Configuration G√©n√©rique:', {
            urlComplete: window.location.href,
            agentParam: agentParam,
            currentAgent: currentAgent,
            agentTitle: agentTitle,
            userID: userID,
            isInIframe: isInIframe,
            sessionVariables: voiceflowConfig.session.variables,
            toutesLesVariablesURL: Object.fromEntries(urlParams)
        });
    </script>
</body>
</html>
